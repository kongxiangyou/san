package org.db.psd.server;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Properties;

import javax.mail.Address;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.db.psd.base.Execute_CRUD;
import org.db.psd.fatory.FatoryModel;

import com.mysql.cj.x.protobuf.MysqlxConnection.Close;

@WebServlet("/es")
public class EmailServer extends HttpServlet {

	 String op = null;
	 String path = null;
	 @Override
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		 this.doPost(request, response);
	}
	@Override
	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		op = request.getParameter("op");
		if(op.equals("byEmail")) {
			doByEmail(request, response);
		}else if(op.equals("update")) {
			
		}
		request.getRequestDispatcher(path).forward(request, response);
	}
	protected void doByEmail(HttpServletRequest request, HttpServletResponse response) {
		//接收方邮箱地址
		String toEmail = request.getParameter("toEmail");
		
		//发送内容
		String context = request.getParameter("context");
		
		//配置参数
		Properties props = new Properties();
		props.setProperty("mail.smtp.auth", "true");//设置访问smtp服务器需要认证
		props.setProperty("mail.transport.protocol", "smtp"); //设置访问服务器的协议
		props.put("mail.smtp.socketFactory.class", "javax.net.ssl.SSLSocketFactory");
        props.put("mail.smtp.port", "465");
        props.put("mail.smtp.socketFactory.port", "465");
		
        //把邮件发送参数加载到邮件会议中
		Session session = Session.getDefaultInstance(props);
		session.setDebug(true); //打开debug功能
		
		Message msg = new MimeMessage(session);
		try {
			msg.setFrom(new InternetAddress("1157457604@qq.com"));
			//设置发件人，163邮箱要求发件人与登录用户必须一致（必填），其它邮箱不了解
			msg.setText(context); //设置邮件内容
			msg.setSubject("修改密码"); //设置邮件主题
			
			Transport trans = session.getTransport();
			trans.connect("smtp.qq.com",465, "1157457604@qq.com", "googfdbkdtwkfjga"); //连接邮箱smtp服务器，25为默认端口
			trans.sendMessage(msg, new Address[]{new InternetAddress(toEmail)}); //发送邮件
			
			trans.close(); //关闭连接
			PrintWriter out;
			try {
				out = response.getWriter();
				out.print("发送成功");
			} catch (IOException e1) { 
				e1.printStackTrace();
			}
			
			
			String sql = "select * from employee where employeeEmail = ?";
			Object[]object= {toEmail};
			Execute_CRUD execute_CRUD = new Execute_CRUD();
			ResultSet rs = execute_CRUD.execute_Query(sql, object);
			try {
				if(rs.next()) {
					String employeeCode = rs.getString("employeeCode");
					request.setAttribute("employeeCode", employeeCode);
					path="/NewPassword.jsp";
				}else {
					try {
						out = response.getWriter();
						out.print("用户不存在！");
					} catch (IOException e1) { 
						e1.printStackTrace();
					}
					path="/login.jsp";
				}
			} catch (SQLException e) { 
				e.printStackTrace();
			}finally {
				execute_CRUD.closeRs(rs);
			}
			 
		} catch (AddressException e) { 
			e.printStackTrace();
		} catch (MessagingException e) { 
			e.printStackTrace();
		} 
	}
	protected void doUpdate(HttpServletRequest request, HttpServletResponse response) throws IOException {
		 
		String employeeCode = request.getParameter("employeeCode");
		
		String employeePassword = request.getParameter("employeePassword");
		boolean b = FatoryModel.getInstanceFatory().getEmployeeDAO().employeeUpdatePassword(employeeCode,employeePassword);
		PrintWriter out = response.getWriter();
		if(b) {
			out.print("修改成功");
			path="/login.jsp";
		}else {
				out.print("修改失败");
			 
			path="/ByEmail.jsp";
		}
	}
}
